/*! For license information please see main.bundle.js.LICENSE.txt */
(()=>{"use strict";function e(){var n,o,r="function"==typeof Symbol?Symbol:{},a=r.iterator||"@@iterator",i=r.toStringTag||"@@toStringTag";function c(e,r,a,i){var c=r&&r.prototype instanceof l?r:l,u=Object.create(c.prototype);return t(u,"_invoke",function(e,t,r){var a,i,c,l=0,u=r||[],d=!1,m={p:0,n:0,v:n,a:h,f:h.bind(n,4),d:function(e,t){return a=e,i=0,c=n,m.n=t,s}};function h(e,t){for(i=e,c=t,o=0;!d&&l&&!r&&o<u.length;o++){var r,a=u[o],h=m.p,f=a[2];e>3?(r=f===t)&&(i=a[4]||3,c=a[5]===n?a[3]:a[5],a[4]=3,a[5]=n):a[0]<=h&&((r=e<2&&h<a[1])?(i=0,m.v=t,m.n=a[1]):h<f&&(r=e<3||a[0]>t||t>f)&&(a[4]=e,a[5]=t,m.n=f,i=0))}if(r||e>1)return s;throw d=!0,t}return function(r,u,f){if(l>1)throw TypeError("Generator is already running");for(d&&1===u&&h(u,f),i=u,c=f;(o=i<2?n:c)||!d;){a||(i?i<3?(i>1&&(m.n=-1),h(i,c)):m.n=c:m.v=c);try{if(l=2,a){if(i||(r="next"),o=a[r]){if(!(o=o.call(a,c)))throw TypeError("iterator result is not an object");if(!o.done)return o;c=o.value,i<2&&(i=0)}else 1===i&&(o=a.return)&&o.call(a),i<2&&(c=TypeError("The iterator does not provide a '"+r+"' method"),i=1);a=n}else if((o=(d=m.n<0)?c:e.call(t,m))!==s)break}catch(e){a=n,i=1,c=e}finally{l=1}}return{value:o,done:d}}}(e,a,i),!0),u}var s={};function l(){}function u(){}function d(){}o=Object.getPrototypeOf;var m=[][a]?o(o([][a]())):(t(o={},a,(function(){return this})),o),h=d.prototype=l.prototype=Object.create(m);function f(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,t(e,i,"GeneratorFunction")),e.prototype=Object.create(h),e}return u.prototype=d,t(h,"constructor",d),t(d,"constructor",u),u.displayName="GeneratorFunction",t(d,i,"GeneratorFunction"),t(h),t(h,i,"Generator"),t(h,a,(function(){return this})),t(h,"toString",(function(){return"[object Generator]"})),(e=function(){return{w:c,m:f}})()}function t(e,n,o,r){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}t=function(e,n,o,r){if(n)a?a(e,n,{value:o,enumerable:!r,configurable:!r,writable:!r}):e[n]=o;else{var i=function(n,o){t(e,n,(function(e){return this._invoke(n,o,e)}))};i("next",0),i("throw",1),i("return",2)}},t(e,n,o,r)}function n(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return o(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?o(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,c=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return c=e.done,e},e:function(e){s=!0,i=e},f:function(){try{c||null==n.return||n.return()}finally{if(s)throw i}}}}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=Array(t);n<t;n++)o[n]=e[n];return o}function r(e,t,n,o,r,a,i){try{var c=e[a](i),s=c.value}catch(e){return void n(e)}c.done?t(s):Promise.resolve(s).then(o,r)}function a(e){return function(){var t=this,n=arguments;return new Promise((function(o,a){var i=e.apply(t,n);function c(e){r(i,o,a,c,s,"next",e)}function s(e){r(i,o,a,c,s,"throw",e)}c(void 0)}))}}if(i=localStorage.getItem("token"),c=localStorage.getItem("user"),!(i&&c||(window.location.href="account.html",0)))throw new Error("Not authenticated");var i,c,s=[],l=null;function u(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5101,o=window.location.hostname,r="/api/chat";if("baktipm.com"===o)return t="https://baktipm.com",console.log("Running on baktipm.com domain, using:",t+r),t+r;if("localhost"===o||"127.0.0.1"===o)return t="http://localhost:".concat(n),console.log("Running locally, using:",t+r),t+r;if(!e)return"http://localhost:".concat(n,"/api/chat");var a=e;return a.startsWith("http")||(a="http://"+a),a.includes("localhost")&&!a.includes(":".concat(n))&&(a=a.replace("localhost","localhost:".concat(n))),console.log("Using custom URL:",a),a}var d={port:"5101",apiUrl:u("http://localhost:5101",5101),dashscopeApiKey:"sk-0054022384a64f03abfdbcae8c001cbb",dashscopeUrl:"https://dashscope-intl.aliyuncs.com/api/v1/apps/172f5d2e8d1b4b9da47dada83dcb7f19/completion",proxyUrl:"baktipm.com"===window.location.hostname?"https://baktipm.com/api/chat":u("http://localhost:5101/api/chat",5101)},m=(axios.create({headers:{"Content-Type":"application/json",Accept:"application/json"}}),document.getElementById("chat-container"),document.getElementById("chat-messages")),h=document.getElementById("user-input"),f=document.getElementById("send-button"),p=document.getElementById("chat-history"),g=(document.getElementById("conversation-list"),document.getElementById("history-list")),v=document.getElementById("empty-history"),y=document.getElementById("new-chat"),w=document.getElementById("connection-status"),b=document.getElementById("menu-toggle"),E=document.getElementById("close-sidebar"),k=(document.getElementById("loading"),document.getElementById("theme-toggle")),x=k?k.querySelector("i"):null,I=document.getElementById("user-button"),S=document.getElementById("user-dropdown"),C=document.getElementById("user-avatar"),L=document.getElementById("user-name"),N=document.getElementById("dropdown-user-name"),B=document.getElementById("user-email"),T=document.getElementById("login-button"),D=document.getElementById("logout-button"),A=document.getElementById("clear-history");function O(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}function j(){var e={id:O(),messages:[],timestamp:new Date,preview:"",topic:"New Chat"};s.unshift(e),l=e.id,P(),U(),H();var t="ðŸ‘‹ Hello! I'm your AI assistant. How can I help you today?",n=e.messages.some((function(e){return"assistant"===e.role&&e.content===t}));return s.findIndex((function(t){return t.id===e.id})),0!==e.messages.length||n||(J(t,!1),e.messages.push({role:"assistant",content:t}),e.preview=t),P(),U(),e}function H(){m.innerHTML="",h.value="",h.focus()}function P(){localStorage.setItem("conversations",JSON.stringify(s)),M()}function M(){0===s.length?v.style.display="flex":v.style.display="none"}function U(){g.innerHTML="",0===s.length?(g.appendChild(v),v.style.display="flex"):(v.style.display="none",s.forEach((function(e){var t=document.createElement("div");t.className="history-item",e.id===l&&t.classList.add("active");var n=document.createElement("div");n.className="history-item-header";var o=document.createElement("div");o.className="topic",o.textContent=e.topic||"New Chat";var r,a,i,c=document.createElement("div");c.className="timestamp",c.textContent=(r=e.timestamp,a=new Date,(i=new Date(r)).toDateString()===a.toDateString()?i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):i.getFullYear()===a.getFullYear()?i.toLocaleDateString([],{month:"short",day:"numeric"}):i.toLocaleDateString([],{year:"numeric",month:"short",day:"numeric"}));var u=document.createElement("div");u.className="preview",u.textContent=e.preview||"Empty conversation",document.createElement("div").className="actions";var d=document.createElement("button");d.className="delete-btn",d.innerHTML='<i class="ri-delete-bin-line"></i>',d.title="Delete conversation",d.onclick=function(t){return n=e.id,t.stopPropagation(),void(confirm("Are you sure you want to delete this conversation?")&&(s=s.filter((function(e){return e.id!==n})),n===l&&((l=s.length>0?s[0].id:null)?G(l):H()),P(),U()));var n},n.appendChild(o),n.appendChild(d),t.appendChild(n),t.appendChild(c),t.appendChild(u),t.addEventListener("click",(function(){return G(e.id)})),g.appendChild(t)})))}function G(e){l=e;var t=s.find((function(t){return t.id===e}));t&&(m.innerHTML="",t.messages.forEach((function(e){J(e.content,"user"===e.role,!1)})),U())}function q(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";w.textContent=e,w.className="connection-status "+t}function F(e,t){var n=document.createElement("div");n.className="message ".concat(t?"user-message":"bot-message");var o=document.createElement("div");o.className="avatar",o.innerHTML=t?'<i class="ri-user-line"></i>':'<i class="ri-robot-line"></i>';var r=document.createElement("div");return r.className="message-content",t?r.textContent=e:(r.innerHTML=marked.parse(e),r.querySelectorAll("pre code").forEach((function(e){hljs.highlightBlock(e)}))),n.appendChild(o),n.appendChild(r),{messageDiv:n,contentDiv:r}}function J(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],o=F(e,t),r=o.messageDiv;if(o.contentDiv,m.appendChild(r),m.scrollTop=m.scrollHeight,n){l||j();var a=s.find((function(e){return e.id===l}));a&&(a.messages.push({role:t?"user":"assistant",content:e}),a.preview=e,a.timestamp=new Date,t&&1===a.messages.filter((function(e){return"user"===e.role})).length&&function(e){var t=s.find((function(t){return t.id===e}));t&&(t.topic=function(e){if(0===e.length)return"New Chat";var t=e.find((function(e){return"user"===e.role}));if(!t)return"New Chat";var n=t.content.split("\n")[0].trim();return n.length>40?n.substring(0,37)+"...":n}(t.messages),P(),U())}(l),P(),U())}}function R(){var e=document.createElement("div");e.className="typing-indicator",e.id="typing-indicator";var t=document.createElement("div");t.className="message-avatar",t.innerHTML='<i class="ri-robot-line"></i>';var n=document.createElement("div");n.className="typing-bubble";for(var o=0;o<3;o++){var r=document.createElement("div");r.className="typing-dot",n.appendChild(r)}e.appendChild(t),e.appendChild(n),m.appendChild(e),m.scrollTop=m.scrollHeight}function _(){var e=document.getElementById("typing-indicator");e&&e.remove()}function W(e){return z.apply(this,arguments)}function z(){return z=a(e().m((function t(o){var r,i,c,s,u,m,h,f;return e().w((function(t){for(;;)switch(t.n){case 0:if(t.p=0,q("Connecting...",""),r=d.proxyUrl,i=localStorage.getItem("token")){t.n=1;break}throw new Error("Authentication required. Please login again.");case 1:return t.n=2,fetch(r,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(i)},body:JSON.stringify({message:o,conversationId:l})});case 2:return c=t.v,s=c.body.getReader(),u=new TextDecoder,m="",q("Connected","connected"),t.a(2,new Promise(function(){var t=a(e().m((function t(o,r){var a,i,c,l,d,h,f,p,g,v,y,w,b,E,k,x,I;return e().w((function(e){for(;;)switch(e.n){case 0:e.p=0,a="";case 1:return e.n=2,s.read();case 2:if(i=e.v,c=i.done,l=i.value,!c){e.n=3;break}return e.a(3,18);case 3:m+=u.decode(l,{stream:!0}),d=void 0;case 4:if(-1===(d=m.indexOf("\n\n"))){e.n=17;break}h=m.slice(0,d),m=m.slice(d+2),f=h.split("\n"),p=n(f),e.p=5,p.s();case 6:if((g=p.n()).done){e.n=13;break}if((v=g.value).startsWith("data:")){e.n=7;break}return e.a(3,12);case 7:if(y=v.slice(5).trim()){e.n=8;break}return e.a(3,12);case 8:if("[DONE]"!==y){e.n=9;break}return o({choices:[{message:{content:a}}]}),e.a(2);case 9:if(e.p=9,!(E=JSON.parse(y)).error){e.n=10;break}throw new Error(E.error);case 10:k="",(k=null!==(w=E.choices)&&void 0!==w&&null!==(w=w[0])&&void 0!==w&&null!==(w=w.message)&&void 0!==w&&w.content?E.choices[0].message.content:null!==(b=E.output)&&void 0!==b&&b.text?E.output.text:E.text?E.text:E.content?E.content:JSON.stringify(E))&&k.trim()&&(a+=k,window.dispatchEvent(new CustomEvent("partialResponse",{detail:{content:k}}))),e.n=12;break;case 11:e.p=11,e.v,y.startsWith("id:");case 12:e.n=6;break;case 13:e.n=15;break;case 14:e.p=14,x=e.v,p.e(x);case 15:return e.p=15,p.f(),e.f(15);case 16:e.n=4;break;case 17:e.n=1;break;case 18:e.n=20;break;case 19:e.p=19,I=e.v,r(I);case 20:return e.a(2)}}),t,null,[[9,11],[5,14,15,16],[0,19]])})));return function(e,n){return t.apply(this,arguments)}}()));case 3:throw t.p=3,f=t.v,q("Error: ".concat((null===(h=f.response)||void 0===h||null===(h=h.data)||void 0===h?void 0:h.message)||f.message),"error"),f;case 4:return t.a(2)}}),t,null,[[0,3]])}))),z.apply(this,arguments)}function Y(){return $.apply(this,arguments)}function $(){return($=a(e().m((function t(){var n,o,r,a,i,c,u,d,f,p,g,v;return e().w((function(e){for(;;)switch(e.n){case 0:if(n=h.value.trim()){e.n=1;break}return alert("Please enter a message before sending."),e.a(2);case 1:return l&&s.find((function(e){return e.id===l}))||(o=j(),l=o.id),h.value="",J(n,!0),R(),e.p=2,_(),r="temp-"+Date.now(),a=F("",!1),i=a.messageDiv,a.contentDiv.id=r,m.appendChild(i),m.scrollTop=m.scrollHeight,c="",u=function(e){var t=e.detail.content;c+=t;var n=document.getElementById(r);if(n){n.textContent=c;try{n.innerHTML=marked.parse(c),n.querySelectorAll("pre code").forEach((function(e){hljs.highlightBlock(e)}))}catch(e){}m.scrollTop=m.scrollHeight}},window.addEventListener("partialResponse",u),e.n=3,W(n);case 3:if(d=e.v,window.removeEventListener("partialResponse",u),"",!d){e.n=4;break}if(f=d.choices&&d.choices[0]&&d.choices[0].message?d.choices[0].message.content:d.output&&d.output.text?d.output.text:d.text?d.text:d.content?d.content:c,p=document.getElementById(r))try{p.innerHTML=marked.parse(f),p.querySelectorAll("pre code").forEach((function(e){hljs.highlightBlock(e)}))}catch(e){p.textContent=f}m.scrollTop=m.scrollHeight,(g=s.find((function(e){return e.id===l})))&&(g.messages.push({role:"assistant",content:f}),g.preview=f,g.timestamp=new Date,P(),U()),e.n=5;break;case 4:throw new Error("Invalid API response format");case 5:e.n=7;break;case 6:e.p=6,v=e.v,console.error("Chat error:",v),_(),J("Sorry, I encountered an error. Please try again later.",!1);case 7:return e.a(2)}}),t,null,[[2,6]])})))).apply(this,arguments)}function K(){return localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}function Q(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];document.documentElement.style.setProperty("--transition-normal","none"),document.body.classList.remove("light-theme","dark-theme"),requestAnimationFrame((function(){document.body.classList.add("".concat(e,"-theme")),document.documentElement.style.setProperty("--transition-normal","all 0.3s ease"),t&&localStorage.setItem("theme",e),function(e){var t="dark"===e;x&&(x.className=t?"ri-sun-line":"ri-moon-line"),k&&(k.setAttribute("title","Switch to ".concat(t?"light":"dark"," mode")),k.setAttribute("aria-label","Switch to ".concat(t?"light":"dark"," mode")))}(e)}))}marked.setOptions({highlight:function(e,t){var n=hljs.getLanguage(t)?t:"plaintext";return hljs.highlight(e,{language:n}).value},langPrefix:"hljs language-",gfm:!0,breaks:!0}),Q(K(),!1),Z(k,"click",(function(){Q("dark"===(localStorage.getItem("theme")||K())?"light":"dark")}));var V=window.matchMedia("(prefers-color-scheme: dark)");function X(){var e=JSON.parse(localStorage.getItem("user"));if(localStorage.getItem("token")&&e){var t=e.avatar||"https://ui-avatars.com/api/?name=".concat(encodeURIComponent(e.name),"&background=7c3aed&color=fff");C.src=t,document.querySelector(".user-info img").src=t,L&&(L.textContent=e.name),N&&(N.textContent=e.name),B&&(B.textContent=e.email),T&&T.classList.add("hidden"),D&&D.classList.remove("hidden")}else{var n="https://ui-avatars.com/api/?name=Guest&background=7c3aed&color=fff";C.src=n,document.querySelector(".user-info img").src=n,L.textContent="Guest",N.textContent="Guest",B.textContent="Not signed in",T.classList.remove("hidden"),D.classList.add("hidden")}}function Z(e,t,n){e?e.addEventListener(t,n):console.error("Element for event ".concat(t," not found"))}if(V&&V.addEventListener("change",(function(e){localStorage.getItem("theme")||Q(e.matches?"dark":"light",!1)})),Z(b,"click",(function(){p&&p.classList.toggle("show")})),Z(E,"click",(function(){p&&p.classList.remove("show")})),document.addEventListener("click",(function(e){if(window.innerWidth<=768){var t=p.contains(e.target),n=b.contains(e.target);t||n||!p.classList.contains("show")||p.classList.remove("show")}})),Z(I,"click",(function(){S&&S.classList.toggle("hidden")})),document&&document.addEventListener("click",(function(e){I&&S&&!I.contains(e.target)&&!S.contains(e.target)&&S.classList.add("hidden")})),Z(T,"click",(function(){window.location.href="account.html"})),Z(D,"click",(function(){confirm("Are you sure you want to sign out?")&&(localStorage.removeItem("token"),localStorage.removeItem("user"),X(),window.location.href="account.html")})),X(),Z(f,"click",Y),Z(y,"click",j),Z(A,"click",(function(){if(confirm("Are you sure you want to delete all conversation history? This action cannot be undone.")){var e=function(){var e=JSON.parse(localStorage.getItem("user"));return e?e.id:null}();e?fetch("/api/conversations/clear",{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(localStorage.getItem("token"))}}).then((function(e){if(e.ok)return s=[],P(),U(),j(),e.json();throw new Error("Failed to clear conversation history")})).then((function(e){console.log("Cleared history:",e)})).catch((function(e){console.error("Error clearing history:",e),alert("Failed to clear conversation history. Please try again.")})):(s=[],P(),U(),j())}})),h?h.addEventListener("keypress",(function(e){"Enter"===e.key&&Y()})):console.error("User input element not found"),function(){var e=localStorage.getItem("conversations");if(e){s=JSON.parse(e);var t=!1;s.forEach((function(e){var n;n=e.id,/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(n)||(console.log("Converting old conversation ID ".concat(e.id," to UUID format")),e.id=O(),t=!0)})),t&&(console.log("Saving migrated conversation IDs"),localStorage.setItem("conversations",JSON.stringify(s))),s.length>0&&(l=s[0].id,s.forEach((function(e){e.timestamp=new Date(e.timestamp)})))}else s=[];U(),M()}(),0===s.length){var ee={id:O(),messages:[],timestamp:new Date,preview:"",topic:"New Chat"};s.unshift(ee),l=ee.id;var te="ðŸ‘‹ Hello! I'm your AI assistant. How can I help you today?";J(te,!1),ee.messages.push({role:"assistant",content:te}),ee.preview=te,P(),U(),H()}})();
//# sourceMappingURL=main.bundle.js.map